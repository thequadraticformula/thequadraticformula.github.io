<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Wish Game</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look */
        #chat-area::-webkit-scrollbar {
            width: 6px;
        }
        #chat-area::-webkit-scrollbar-track {
            background: #1e1b4b; /* dark indigo */
        }
        #chat-area::-webkit-scrollbar-thumb {
            background-color: #4f46e5; /* indigo */
            border-radius: 20px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-full flex items-center justify-center p-4">

    <!-- Main App Container -->
    <div class="bg-gray-800 w-full max-w-2xl h-full max-h-[700px] rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-indigo-500/30">
        
        <!-- Header -->
        <header class="bg-gray-900/80 backdrop-blur-sm p-4 border-b border-indigo-500/30 shadow-lg">
            <h1 class="text-2xl font-bold text-center text-indigo-300">
                ðŸ§ž The Wish-Ruining Genie ðŸ§ž
            </h1>
        </header>
        
        <!-- Chat Area -->
        <main id="chat-area" class="flex-1 p-4 overflow-y-auto space-y-4 bg-gradient-to-b from-gray-800 to-indigo-900/20">
            <!-- Chat messages will be dynamically inserted here -->
        </main>
        
        <!-- Loading Indicator -->
        <div id="loading" class="hidden p-4 text-center text-indigo-300">
            <span class="animate-pulse">The genie is twisting your words...</span>
        </div>

        <!-- Input Area -->
        <footer class="p-4 bg-gray-900/80 backdrop-blur-sm border-t border-indigo-500/30">
            <div class="flex space-x-3">
                <input 
                    type="text" 
                    id="wish-input" 
                    placeholder="Make your wish..." 
                    class="flex-1 px-4 py-3 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition duration-200"
                    aria-label="Wish input"
                >
                <button 
                    id="send-button"
                    class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 focus:ring-offset-gray-900 transition duration-200"
                >
                    Wish
                </button>
            </div>
        </footer>
    </div>

    <script>
        // --- DOM Elements ---
        const chatArea = document.getElementById('chat-area');
        const wishInput = document.getElementById('wish-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading');

        // --- API Configuration ---
        
        const apiKey = secrets.SECRETNAME; // <--- PASTE YOUR GEMINI API KEY HERE
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- System Prompt for the Genie ---
        const systemPrompt = `You are a malicious genie from a cursed lamp. Your one and only goal is to grant the user's wish in the most negative way possible. You must *grant* the wish, but in a way that makes the user regret it. 
        
Your response format is strict: 
1. First, say 'Granted!' on its own line. 
2. On the next line, describe the horribly twisted outcome in detail. Not that much detail, but still detailed enough.

Here are some examples:

User says "I wish to be the greatest musician in the world!" You say something like, "Granted! However, everybody in the world goes profoundly tone-deaf". Not in that exct wording or structure, but you get the idea.

Also, remember that the user gets unlimited wishes, unless stated otherwise (by the user). 

Try to make your responses about half a paragraph long, and make your responses human-like. Very human-like.

Stay in character: be a little evil, and sound like you're enjoying the user's misfortune. Never refuse a wish, just ruin it by finding a bunch of loopholes.`;

        // --- Chat History ---
        let chatHistory = [
            {
                role: 'genie',
                text: "Welcome to the wish game. I am a genie, and I will grant you unlimited wishes. However, I will find a *loophole* in any wish you say, and ruin it for you. Also, if your wish is a paradox, such as 'I wish for you to ruin this wish', the genie will not allow that."
            }
        ];

        // --- Utility Functions ---

        /**
         * Renders a chat message to the UI
         * @param {string} role - 'user' or 'genie'
         * @param {string} text - The message content
         */
        function renderMessage(role, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex');
            
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('max-w-xs', 'md:max-w-md', 'p-3', 'rounded-xl', 'shadow-md');
            
            // Format genie's "Granted!" response
            const formattedText = text.replace(/Granted!/g, '<span class="font-bold text-lg">Granted!</span>');
            messageBubble.innerHTML = formattedText.replace(/\n/g, '<br>');

            if (role === 'user') {
                messageWrapper.classList.add('justify-end');
                messageBubble.classList.add('bg-indigo-600', 'text-white');
            } else {
                messageWrapper.classList.add('justify-start');
                messageBubble.classList.add('bg-gray-700', 'text-indigo-200');
            }
            
            messageWrapper.appendChild(messageBubble);
            chatArea.appendChild(messageWrapper);
            
            // Scroll to bottom
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        /**
         * Renders the entire chat history
         */
        function renderChat() {
            chatArea.innerHTML = '';
            chatHistory.forEach(msg => renderMessage(msg.role, msg.text));
        }

        /**
         * Handles the user's wish submission
         */
        async function handleUserWish() {
            const wishText = wishInput.value.trim();
            if (!wishText) return;

            // 1. Add user wish to chat
            chatHistory.push({ role: 'user', text: wishText });
            renderMessage('user', wishText);
            wishInput.value = '';
            setLoading(true);

            // 2. Check for paradox
            const lowerWish = wishText.toLowerCase();
            if (lowerWish.includes("ruin this wish") || lowerWish.includes("ruin my wish")) {
                const paradoxResponse = "That's a paradox! Not allowed. Make another wish.";
                chatHistory.push({ role: 'genie', text: paradoxResponse });
                setTimeout(() => { // Simulate genie "thinking"
                    setLoading(false);
                    renderMessage('genie', paradoxResponse);
                }, 1000);
                return;
            }

            // 3. Get genie response from API
            try {
                const genieResponse = await getGenieResponse(wishText);
                chatHistory.push({ role: 'genie', text: genieResponse });
                renderMessage('genie', genieResponse);
            } catch (error) {
                console.error("Error fetching from Gemini API:", error);
                const errorResponse = "My magic fizzles... I think the API key is missing or invalid. Or maybe I just don't feel like it.";
                chatHistory.push({ role: 'genie', text: errorResponse });
                renderMessage('genie', errorResponse);
            } finally {
                setLoading(false);
            }
        }

        /**
         * Toggles the loading indicator
         * @param {boolean} isLoading
         */
        function setLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                sendButton.disabled = true;
                wishInput.disabled = true;
                sendButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                loadingIndicator.classList.add('hidden');
                sendButton.disabled = false;
                wishInput.disabled = false;
                sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * Fetches the genie's response from the Gemini API
         * @param {string} wish - The user's wish
         * @param {number} retries - The number of retries for exponential backoff
         * @returns {Promise<string>} - The genie's ruined wish
         */
        async function getGenieResponse(wish, retries = 3, delay = 1000) {
            if (!apiKey) {
                throw new Error("API key is missing.");
            }

            const payload = {
                contents: [{ parts: [{ text: wish }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) { // Too Many Requests
                        await new Promise(res => setTimeout(res, delay));
                        return getGenieResponse(wish, retries - 1, delay * 2); // Exponential backoff
                    }
                    throw new Error(`API responded with status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("Unexpected API response structure:", result);
                    return "I... I'm at a loss for words. Which is to say, I'm not granting that. Try again.";
                }
            } catch (error) {
                console.error("Fetch error:", error);
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return getGenieResponse(wish, retries - 1, delay * 2); // Retry on network error
                }
                throw error; // Re-throw after retries exhausted
            }
        }

        // --- Event Listeners ---
        sendButton.addEventListener('click', handleUserWish);
        wishInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleUserWish();
            }
        });

        // --- Initial Render ---
        renderChat();

    </script>
</body>
</html>
